<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百人一首 暗記</title>
    <style>
        :root { --bg: #fdfaf1; --accent: #8b4513; --text: #333; --card-bg: #ffffff; --warn: #f1c40f; --bad: #e74c3c; --good: #2ecc71; }
        body { font-family: "Sawarabi Mincho", serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .page { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .active { display: flex; }
        .setting-group { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 100%; max-width: 340px; margin-bottom: 15px; }
        .setting-item { margin-bottom: 12px; }
        label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        #card-container { position: relative; width: 100%; max-width: 320px; height: 50vh; margin-bottom: 20px; flex-shrink: 0; }
        #card { background: var(--card-bg); width: 100%; height: 100%; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; padding: 20px; cursor: pointer; border: 2px solid var(--accent); box-sizing: border-box; position: relative; }
        .poem-text { writing-mode: vertical-rl; font-size: 1.4rem; line-height: 2.0; letter-spacing: 0.15rem; height: 85%; text-align: start; }
        .label { position: absolute; top: 15px; left: 15px; font-size: 0.8rem; color: var(--accent); border: 1px solid var(--accent); padding: 2px 8px; border-radius: 4px; }
        #mark-btn { position: absolute; top: 10px; right: 10px; width: 44px; height: 44px; border-radius: 50%; border: 2px solid #ddd; background: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .mark-none { border-color: #ddd !important; color: #ddd; }
        .mark-warn { border-color: var(--warn) !important; color: var(--warn); background: #fef9e7 !important; }
        .mark-bad  { border-color: var(--bad) !important; color: var(--bad); background: #fdedec !important; }
        .mark-good { border-color: var(--good) !important; color: var(--good); background: #eafaf1 !important; }
        .result-card { background: white; padding: 20px; border-radius: 15px; width: 100%; max-width: 320px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 15px 0; }
        .stat-item { padding: 8px; border-radius: 8px; font-size: 0.85rem; }
        .bad-list { text-align: left; max-height: 120px; overflow-y: auto; font-size: 0.8rem; background: #f8f8f8; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #eee; }
        button { width: 100%; max-width: 240px; padding: 15px; border: none; border-radius: 30px; background: var(--accent); color: white; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 0 #5d2e0d; margin-top: 10px; flex-shrink: 0; }
        button:active { transform: translateY(2px); box-shadow: none; }
        .secondary-btn { background: #666; box-shadow: 0 4px 0 #333; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="setup-page" class="page active">
        <h2 style="margin: 0 0 10px 0;">練習の設定</h2>
        <div class="setting-group">
            <div class="setting-item">
                <label>出題範囲 (1〜100)</label>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="number" id="range-start" value="1" min="1" max="100">
                    <span>〜</span>
                    <input type="number" id="range-end" value="100" min="1" max="100">
                </div>
            </div>
            <div class="setting-item">
                <label>番号の絞り込み</label>
                <select id="number-filter">
                    <option value="all">すべて</option>
                    <option value="odd">奇数番のみ</option>
                    <option value="even">偶数番のみ</option>
                </select>
            </div>
            <div class="setting-item"><label>モード</label><select id="quiz-mode"><option value="kami-to-simo">上の句 → 下の句</option><option value="simo-to-kami">下の句 → 上の句</option></select></div>
            <div class="setting-item"><label>順序</label><select id="order-mode"><option value="random">ランダム</option><option value="sequential">番号順</option></select></div>
            <div class="setting-item"><label>マークで絞り込み</label>
                <select id="filter-mark">
                    <option value="all">すべて</option>
                    <option value="warn">黄色のみ</option>
                    <option value="bad">赤色のみ</option>
                    <option value="good">緑色のみ</option>
                </select>
            </div>
        </div>
        <button onclick="startLearning()">暗記を始める</button>
    </div>

    <div id="learning-page" class="page">
        <div style="margin-bottom: 8px; font-size: 0.85rem;"><span id="progress-text">0 / 0</span></div>
        <div id="card-container">
            <div id="mark-btn" onclick="toggleMark(event)" class="mark-none">★</div>
            <div id="card" onclick="toggleAnswer()">
                <span class="label" id="poem-id"></span>
                <div id="display-text" class="poem-text"></div>
            </div>
        </div>
        <button id="next-btn" onclick="nextPoem()">次の歌へ</button>
        <button class="secondary-btn" onclick="showSetup()">設定に戻る</button>
    </div>

    <div id="result-page" class="page">
        <div class="result-card">
            <h3 style="margin:0 0 5px 0;">一周しました！</h3>
            <div id="result-summary" style="font-size:0.85rem;"></div>
            <div class="stat-grid">
                <div class="stat-item" style="background:#fdedec; color:var(--bad);">赤色: <span id="stat-bad">0</span></div>
                <div class="stat-item" style="background:#fef9e7; color:var(--warn);">黄色: <span id="stat-warn">0</span></div>
                <div class="stat-item" style="background:#eafaf1; color:var(--good);">緑色: <span id="stat-good">0</span></div>
                <div class="stat-item" style="background:#f5f5f5;">未設定: <span id="stat-none">0</span></div>
            </div>
            <div style="text-align:left; font-size:0.85rem; font-weight:bold;">赤色の句一覧:</div>
            <div id="bad-list" class="bad-list"></div>
        </div>
        <button onclick="startLearning()">もう一度練習する</button>
        <button class="secondary-btn" onclick="showSetup()">設定に戻る</button>
    </div>

    <script>
        const poemsData = [
            {id:1, kami:"秋の田のかりほの庵の苫を荒み", simo:"わがころも手は露に濡れつつ"},
            {id:2, kami:"春すぎて夏来にけらし白たへの", simo:"ころもほすてふあまの香具山"},
            {id:3, kami:"あしひきの山鳥の尾のしだり尾の", simo:"ながながし夜をひとりかも寝む"},
            {id:4, kami:"田子の浦にうちいでて見れば白たへの", simo:"富士の高嶺に雪は降りつつ"},
            {id:5, kami:"奥山にもみぢ踏み分け鳴く鹿の", simo:"声聞く時ぞ秋は悲しき"},
            {id:6, kami:"かささぎの渡せる橋に置く霜の", simo:"白きを見れば夜ぞふけにける"},
            {id:7, kami:"あまの原ふりさけ見ればかすがなる", simo:"み笠の山にいでし月かも"},
            {id:8, kami:"わが庵は都のたつみしかぞ住む", simo:"世を宇治山と人は言ふなり"},
            {id:9, kami:"花の色はうつりにけりないたづらに", simo:"わが身世にふるながめせしまに"},
            {id:10, kami:"これやこの行くも帰るも別れては", simo:"知るも知らぬも逢坂の関"},
            {id:11, kami:"わたの原八十島かけて漕ぎいでぬと", simo:"人には告げよあまの釣舟"},
            {id:12, kami:"あまつ風雲のかよひ路吹きとぢよ", simo:"をとめの姿しばしとどめむ"},
            {id:13, kami:"つくばねの峰より落つるみなの川", simo:"恋ぞ積りて淵となりぬる"},
            {id:14, kami:"みちのくの忍ぶもぢずり誰ゆゑに", simo:"乱れそめにしわれならなくに"},
            {id:15, kami:"君がため春の野にいでて若菜摘む", simo:"わがころも手に雪は降りつつ"},
            {id:16, kami:"立ち別れいなばの山の峰に生ふる", simo:"まつとし聞かばいざ帰り来む"},
            {id:17, kami:"ちはやふる神代も聞かず竜田川", simo:"からくれなゐに水くくるとは"},
            {id:18, kami:"すみの江の岸による波よるさへや", simo:"夢のかよひ路人目よくらむ"},
            {id:19, kami:"なにはがた短きあしのふしのまも", simo:"あはでこの世をすごしてよとや"},
            {id:20, kami:"わびぬれば今はた同じなにはなる", simo:"みをつくしてもあはむとぞ思ふ"},
            {id:21, kami:"今来むと言ひしばかりに長月の", simo:"有明の月を待ちいでつるかな"},
            {id:22, kami:"吹くからに秋の草木のしをるれば", simo:"むべ山風を嵐と言ふらむ"},
            {id:23, kami:"月見ればちぢにものこそ悲しけれ", simo:"わが身ひとつの秋にはあらねど"},
            {id:24, kami:"このたびはぬさも取りあへずたむけ山", simo:"もみぢのにしき神のまにまに"},
            {id:25, kami:"名にし負はば逢坂山のさねかづら", simo:"人に知られで来るよしもがな"},
            {id:26, kami:"小倉山峰のもみぢ葉心あらば", simo:"今ひとたびのみゆき待たなむ"},
            {id:27, kami:"みかの原わきて流るる泉川", simo:"いつ見きとてか恋しかるらむ"},
            {id:28, kami:"山里は冬ぞ寂しさまさりける", simo:"人目も草もかれぬと思へば"},
            {id:29, kami:"心あてに折らばや折らむ初霜の", simo:"置きまどはせる白菊の花"},
            {id:30, kami:"有明のつれなく見えし別れより", simo:"暁ばかりうきものはなし"},
            {id:31, kami:"朝ぼらけ有明の月と見るまでに", simo:"吉野の里に降れる白雪"},
            {id:32, kami:"山川に風のかけたるしがらみは", simo:"流れもあへぬもみぢなりけり"},
            {id:33, kami:"ひさかたの光のどけき春の日に", simo:"しづ心なく花の散るらむ"},
            {id:34, kami:"たれをかも知る人にせむ高砂の", simo:"松も昔の友ならなくに"},
            {id:35, kami:"人はいさ心も知らずふる里は", simo:"花ぞ昔の香に匂ひける"},
            {id:36, kami:"夏の夜はまだ宵ながら明けぬるを", simo:"雲のいづこに月宿るらむ"},
            {id:37, kami:"白露に風の吹きしく秋の野は", simo:"つらぬきとめぬ玉ぞ散りける"},
            {id:38, kami:"忘らるる身をば思はずちかひてし", simo:"人の命の惜しくもあるかな"},
            {id:39, kami:"浅茅生の小野のしの原忍ぶれど", simo:"あまりてなどか人の恋しき"},
            {id:40, kami:"忍ぶれど色にいでにけりわが恋は", simo:"ものや恩ふと人の問ふまで"},
            {id:41, kami:"恋すてふわが名はまだき立ちにけり", simo:"人知れずこそ思ひそめしか"},
            {id:42, kami:"ちぎりきなかたみに袖をしぼりつつ", simo:"末の松山波越さじとは"},
            {id:43, kami:"あひ見ての後の心にくらぶれば", simo:"昔はものを思はざりけり"},
            {id:44, kami:"あふことの絶えてしなくばなかなかに", simo:"人をも身をも恨みざらまし"},
            {id:45, kami:"あはれとも言ふべき人は思ほえで", simo:"身のいたづらになりぬべきかな"},
            {id:46, kami:"ゆらのとを渡る舟人かぢを絶え", simo:"行くへも知らぬ恋の道かな"},
            {id:47, kami:"八重むぐら茂れるやどの寂しきに", simo:"人こそ見えね秋は来にけり"},
            {id:48, kami:"風をいたみ岩打つ波のおのれのみ", simo:"くだけてものを思ふ頃かな"},
            {id:49, kami:"み垣もり衛士のたく火の夜はもえ", simo:"昼は消えつつものをこそ思へ"},
            {id:50, kami:"君がため惜しからざりし命さへ", simo:"長くもがなと思ひけるかな"},
            {id:51, kami:"かくとだにえやはいぶきのさしも草", simo:"さしもしらじなもゆる思ひを"},
            {id:52, kami:"明けぬれば暮るるものとは知りながら", simo:"なほうらめしき朝ぼらけかな"},
            {id:53, kami:"歎きつつひとりぬる夜の明くるまは", simo:"いかに久しきものとかは知る"},
            {id:54, kami:"忘れじの行く末まではかたければ", simo:"今日を限りの命ともがな"},
            {id:55, kami:"滝の音は絶えて久しくなりぬれど", simo:"名こそ流れてなほ聞こえけれ"},
            {id:56, kami:"あらざらむこの世のほかの思ひ出に", simo:"今ひとたびのあふこともがな"},
            {id:57, kami:"めぐりあひて見しやそれともわかぬまに", simo:"雲隠れにし夜はの月かな"},
            {id:58, kami:"ありま山ゐなの笹原風吹けば", simo:"いでそよ人を忘れやはする"},
            {id:59, kami:"やすらはで寝なましものをさ夜ふけて", simo:"かたぶくまでの月を見しかな"},
            {id:60, kami:"大江山いく野の道の遠ければ", simo:"まだふみも見ずあまの橋立"},
            {id:61, kami:"いにしへの奈良の都の八重桜", simo:"今日九重ににほひぬるかな"},
            {id:62, kami:"夜をこめてとりのそらねははかるとも", simo:"よに逢坂の関は許さじ"},
            {id:63, kami:"今はただ思ひ絶えなむとばかりを", simo:"人づてならで言ふよしもがな"},
            {id:64, kami:"朝ぼらけ宇治の川霧絶え絶えに", simo:"あらはれわたる瀬々の網代木"},
            {id:65, kami:"恨みわびほさぬ袖だにあるものを", simo:"恋にくちなむ名こそ惜しけれ"},
            {id:66, kami:"もろともにあはれと思へ山桜", simo:"花よりほかに知る人もなし"},
            {id:67, kami:"春の夜の夢ばかりなる手枕に", simo:"かひなく立たむ名こそ惜しけれ"},
            {id:68, kami:"心にもあらでうき世にながらへば", simo:"恋しかるべき夜はの月かな"},
            {id:69, kami:"嵐吹くみむろの山のもみぢ葉は", simo:"竜田の川のにしきなりけり"},
            {id:70, kami:"寂しさにやどを立ちいでてながむれば", simo:"いづくも同じ秋の夕暮"},
            {id:71, kami:"夕されば門田の稲葉おとづれて", simo:"あしのまろ屋に秋風ぞ吹く"},
            {id:72, kami:"音に聞くたかしの浜のあだ波は", simo:"かけじや袖の濡れもこそすれ"},
            {id:73, kami:"高砂のをのへの桜咲きにけり", simo:"と山のかすみ立たずもあらなむ"},
            {id:74, kami:"うかりける人を初瀬の山おろし", simo:"激しかれとは祈らぬものを"},
            {id:75, kami:"ちぎりおきしさせもが露を命にて", simo:"あはれ今年の秋もいぬめり"},
            {id:76, kami:"わたの原漕ぎいでて見ればひさかたの", simo:"雲居にまがふ沖つ白波"},
            {id:77, kami:"瀬を旱み岩にせかるる滝川の", simo:"われても末にあはむとぞ思ふ"},
            {id:78, kami:"淡路島かよふ千鳥の鳴く声に", simo:"いく夜寝覚めぬ須磨の関もり"},
            {id:79, kami:"秋風にたなびく雲の絶え間より", simo:"もれいづる月の影のさやけさ"},
            {id:80, kami:"長からむ心も知らず黒髪の", simo:"乱れて今朝はものをこそ思へ"},
            {id:81, kami:"ほととぎす鳴きつるかたをながむれば", simo:"ただ有明の月ぞ残れる"},
            {id:82, kami:"思ひわびさても命はあるものを", simo:"うきにたへぬは涙なりけり"},
            {id:83, kami:"世の中よ道こそなけれ思ひ入る", simo:"山の奥にも鹿ぞ鳴くなる"},
            {id:84, kami:"長らへばまたこの頃やしのばれむ", simo:"うしと見し世ぞ今は恋しき"},
            {id:85, kami:"夜もすがらもの思ふ頃は明けやらで", simo:"ねやのひまさへつれなかりけり"},
            {id:86, kami:"歎けとて月やはものを思はする", simo:"かこち顔なるわか涙かな"},
            {id:87, kami:"むらさめの露もまだひぬまきの葉に", simo:"霧たちのぼる秋の夕暮れ"},
            {id:88, kami:"なには江のあしのかり寝のひとよゆゑ", simo:"身をつくしてや恋ひわたるべき"},
            {id:89, kami:"玉の緒よ絶えなば絶えね長らへば", simo:"忍ぶることの弱りもぞする"},
            {id:90, kami:"見せばやな雄島のあまの袖だにも", simo:"濡れにぞ濡れし色は変らず"},
            {id:91, kami:"きりぎりす鳴くや霜夜のさむしろに", simo:"ころもかた敷きひとりかも寝む"},
            {id:92, kami:"わが袖は潮ひに見えぬ沖の石の", simo:"人こそ知らね乾くまもなし"},
            {id:93, kami:"世の中は常にもがもななぎさ漕ぐ", simo:"あまのを舟の綱手かなしも"},
            {id:94, kami:"み吉野の山の秋風さ夜ふけて", simo:"ふるさと寒くころも打つなり"},
            {id:95, kami:"おほけなくうき世の民におほふかな", simo:"わが立つそまに墨染の袖"},
            {id:96, kami:"花さそふ嵐の庭の雪ならで", simo:"ふりゆくものはわが身なりけり"},
            {id:97, kami:"来ぬ人をまつほの浦の夕なぎに", simo:"やくやもしほの身もこがれつつ"},
            {id:98, kami:"風そよぐならの小川の夕暮は", simo:"みそぎぞ夏のしるしなりける"},
            {id:99, kami:"人も惜し人も恨めしあぢきなく", simo:"世を思ふゆゑにもの思ふ身は"},
            {id:100, kami:"ももしきや古き軒ばの忍ぶにも", simo:"なほあまりある昔なりけり"}
        ];

        let marks = JSON.parse(localStorage.getItem('hyakunin_marks') || '{}');
        let currentPool = [];
        let currentIndex = 0;
        let countCompleted = 0;
        let isAnswerShowing = false;
        let quizMode, orderMode;
        const markValues = ['none', 'warn', 'bad', 'good'];

        function showSetup() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('setup-page').classList.add('active');
        }

        function startLearning() {
            const start = parseInt(document.getElementById('range-start').value);
            const end = parseInt(document.getElementById('range-end').value);
            const numFilter = document.getElementById('number-filter').value;
            const filterMark = document.getElementById('filter-mark').value;
            quizMode = document.getElementById('quiz-mode').value;
            orderMode = document.getElementById('order-mode').value;

            currentPool = poemsData.filter(p => {
                const inRange = p.id >= start && p.id <= end;
                const matchesNum = (numFilter === 'all') || (numFilter === 'odd' && p.id % 2 !== 0) || (numFilter === 'even' && p.id % 2 === 0);
                const mark = marks[p.id] || 'none';
                const matchesMark = (filterMark === 'all') || (mark === filterMark);
                return inRange && matchesNum && matchesMark;
            });

            if (currentPool.length === 0) { alert("該当する歌がありません。"); return; }
            if (orderMode === 'sequential') currentPool.sort((a, b) => a.id - b.id);
            currentIndex = 0;
            countCompleted = 0;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('learning-page').classList.add('active');
            updateCard();
        }

        function updateCard() {
            const p = currentPool[currentIndex];
            const mark = marks[p.id] || 'none';
            document.getElementById('poem-id').innerText = `第${p.id}首`;
            document.getElementById('display-text').innerText = (quizMode === 'kami-to-simo') ? p.kami : p.simo;
            document.getElementById('mark-btn').className = 'mark-' + mark;
            document.getElementById('progress-text').innerText = `${countCompleted + 1} / ${currentPool.length}`;
            document.getElementById('next-btn').innerText = (countCompleted === currentPool.length - 1) ? "結果を見る" : "次の歌へ";
            isAnswerShowing = false;
        }

        function toggleAnswer() {
            const p = currentPool[currentIndex];
            document.getElementById('display-text').innerText = isAnswerShowing ? 
                (quizMode === 'kami-to-simo' ? p.kami : p.simo) : 
                (quizMode === 'kami-to-simo' ? p.simo : p.kami);
            isAnswerShowing = !isAnswerShowing;
        }

        function toggleMark(e) {
            e.stopPropagation();
            const p = currentPool[currentIndex];
            let currentMark = marks[p.id] || 'none';
            marks[p.id] = markValues[(markValues.indexOf(currentMark) + 1) % markValues.length];
            localStorage.setItem('hyakunin_marks', JSON.stringify(marks));
            updateCard();
        }

        function nextPoem() {
            countCompleted++;
            if (countCompleted >= currentPool.length) { showResult(); return; }
            if (orderMode === 'random') {
                let nextIdx;
                do { nextIdx = Math.floor(Math.random() * currentPool.length); } while (nextIdx === currentIndex && currentPool.length > 1);
                currentIndex = nextIdx;
            } else {
                currentIndex = (currentIndex + 1) % currentPool.length;
            }
            updateCard();
        }

        function showResult() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('result-page').classList.add('active');
            let stats = { none: 0, warn: 0, bad: 0, good: 0 };
            let badListHtml = "";
            currentPool.forEach(p => {
                const m = marks[p.id] || 'none';
                stats[m]++;
                if (m === 'bad') badListHtml += `<div>第${p.id}首: ${p.kami.substring(0,12)}...</div>`;
            });
            document.getElementById('stat-none').innerText = stats.none;
            document.getElementById('stat-warn').innerText = stats.warn;
            document.getElementById('stat-bad').innerText = stats.bad;
            document.getElementById('stat-good').innerText = stats.good;
            document.getElementById('bad-list').innerHTML = badListHtml || "赤色の句はありません。";
            document.getElementById('result-summary').innerText = `${currentPool.length}首の練習を完了`;
        }
    </script>
</body>
</html>
